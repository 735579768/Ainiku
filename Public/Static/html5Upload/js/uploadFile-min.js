function UPLOADFILE(){this.fileInput=null,this.uploadInput=null,this.dragDrop=null,this.url="",this.data={},this.uploadFile=[],this.lastUploadFile=[],this.perUploadFile=[],this.fileNum=0,this.filterFile=function(a){return a},this.onSelect=function(){},this.onDelete=function(){},this.onProgress=function(){},this.onSuccess=function(){},this.onFailure=function(){},this.onComplete=function(){},this.funDragHover=function(a){return a.stopPropagation(),a.preventDefault(),this["dragover"===a.type?"onDragOver":"onDragLeave"].call(a.target),this},this.funGetFiles=function(a){var c,d,e,f,b=this;return this.funDragHover(a),c=a.target.files||a.dataTransfer.files,b.lastUploadFile=this.uploadFile,this.uploadFile=this.uploadFile.concat(this.filterFile(c)),d=[],e=[],f=[],$.each(b.lastUploadFile,function(a,b){e.push(b.name)}),$.each(b.uploadFile,function(a,b){f.push(b.name)}),$.each(f,function(a,c){$.inArray(c,e)<0&&d.push(b.uploadFile[a])}),this.uploadFile=d,this.funDealtFiles(),!0},this.funDealtFiles=function(){var b,a=this;return $.each(this.uploadFile,function(b,c){c.index=a.fileNum,a.fileNum++}),b=this.uploadFile,this.perUploadFile=this.perUploadFile.concat(this.uploadFile),this.uploadFile=this.lastUploadFile.concat(this.uploadFile),this.onSelect(b,this.uploadFile),this},this.funDeleteFile=function(a,b){var c=this,d=[],e=this.perUploadFile[a];return $.each(this.uploadFile,function(a,b){e!=b&&d.push(b)}),this.uploadFile=d,b&&c.onDelete(e,this.uploadFile),!0},this.funUploadFiles=function(){var a=this;$.each(this.uploadFile,function(b,c){a.funUploadFile(c)})},this.funUploadFile=function(a){var d,e,f,b=this,c=new FormData;c.append("filelist",a),d=this.data;for(e in d)c.append(e,d[e]);f=new XMLHttpRequest,f.upload.addEventListener("progress",function(c){b.onProgress(a,c.loaded,c.total)},!1),f.addEventListener("load",function(){b.funDeleteFile(a.index,!1),b.onSuccess(a,f.responseText),0==b.uploadFile.length&&b.onComplete("全部完成")},!1),f.addEventListener("error",function(){b.onFailure(a,f.responseText)},!1),f.open("POST",b.url,!0),f.setRequestHeader("X_FILENAME",encodeURIComponent(a.name)),f.send(c)},this.funReturnNeedFiles=function(){return this.uploadFile},this.init=function(){var a=this;this.dragDrop&&(this.dragDrop.addEventListener("dragover",function(b){a.funDragHover(b)},!1),this.dragDrop.addEventListener("dragleave",function(b){a.funDragHover(b)},!1),this.dragDrop.addEventListener("drop",function(b){a.funGetFiles(b)},!1)),a.fileInput&&this.fileInput.addEventListener("change",function(b){a.funGetFiles(b)},!1),a.uploadInput&&this.uploadInput.addEventListener("click",function(b){a.funUploadFiles(b)},!1)}}!function(a){a.fn.zyUpload=function(b){var e,d=Array.prototype.slice.call(arguments,1);if("string"==typeof b){if(e=this[0][b],a.isFunction(e))return e.apply(this,d);throw"zyUpload - No such method: "+b}return this.each(function(){var c={},d=this,e={data:{},width:"700px",height:"400px",itemWidth:"140px",itemHeight:"120px",url:"/upload/UploadAction",multiple:!0,dragDrop:!0,del:!0,finishDel:!1,onSelect:function(){},onDelete:function(){},onSuccess:function(){},onFailure:function(){},onComplete:function(){}};c=a.extend(e,b),this.init=function(){this.createHtml(),this.createCorePlug()},this.createHtml=function(){var e,f,b="";b=c.multiple?"multiple":"",e="",c.dragDrop?(e+='<form class="uploadForm" action="'+c.url+'" method="post" enctype="multipart/form-data">',e+=' <div class="upload_box">',e+='  <div class="upload_main">',e+='   <div class="upload_choose">',e+='    <div class="convent_choice">',e+='     <div class="andArea">',e+='      <div class="filePicker"><b class="addimg">+</b>添加文件</div>',e+='      <input   class="fileImage"  type="file" size="30" name="fileselect[]" '+b+">",e+="     </div>",e+="    </div>",e+='    <span  class="fileDragArea upload_drag_area">或者将文件拖到此处</span>',e+="   </div>",e+='   <div class="status_bar">',e+='    <div  class="info status_info">选中0张，共0B。</div>',e+='    <div class="btns">',e+='     <div class="webuploader_pick">继续选择</div>',e+='     <div class="upload_btn">开始上传</div>',e+="    </div>",e+="   </div>",e+='   <div  class="preview upload_preview"></div>',e+="  </div>",e+='  <div class="upload_submit">',e+='   <button type="button"  class="fileSubmit upload_submit_btn">确认上传文件</button>',e+="  </div>",e+='  <div id="uploadInf" class="upload_inf"></div>',e+=" </div>",e+="</form>"):(f=parseInt(c.itemWidth.replace("px",""))-15,e+='<form class="uploadForm" action="'+c.url+'" method="post" enctype="multipart/form-data">',e+=' <div class="upload_box">',e+='  <div class="upload_main single_main">',e+='   <div class="status_bar">',e+='    <div class="info status_info">选中0张，共0B。</div>',e+='    <div class="btns">',e+='     <input class="fileImage" type="file" size="30" name="fileselect[]" '+b+">",e+='     <div class="webuploader_pick">选择文件</div>',e+='     <div class="upload_btn">开始上传</div>',e+="    </div>",e+="   </div>",e+='   <div  class="preview upload_preview">',e+='    <div class="add_upload">',e+='     <a style="height:'+c.itemHeight+";width:"+c.itemWidth+';" title="点击添加文件" id="" class="rapidAddImg    add_imgBox" href="javascript:void(0)">',e+='      <div class="uploadImg" style="width:'+f+'px">',e+='       <img class="upload_image" src="/Public/Static/html5Upload/images/add_img.png" style="width:expression(this.width > '+f+" ? "+f+'px : this.width)" />',e+="      </div>",e+="     </a>",e+="    </div>",e+="   </div>",e+="  </div>",e+='  <div class="upload_submit">',e+='   <button type="button"  class="fileSubmit upload_submit_btn">确认上传文件</button>',e+="  </div>",e+='  <div id="uploadInf" class="upload_inf"></div>',e+=" </div>",e+="</form>"),a(d).append(e).css({width:c.width,height:c.height}),this.addEvent()},this.funSetStatusInfo=function(b){var d=0,e=b.length;a.each(b,function(a,b){d+=b.size}),d=d>1048576?(Math.round(100*d/1048576)/100).toString()+"MB":(Math.round(100*d/1024)/100).toString()+"KB",a(c.parentsel+" .status_info").html("选中"+e+"张，共"+d+"。")},this.funFilterEligibleFile=function(a){var d,c,b=[];for(c=0;d=a[c];c++)d.size>=512e6?alert('您这个"'+d.name+'"文件大小过大'):b.push(d);return b},this.funDisposePreviewHtml=function(a,b){var g,d="",e=parseInt(c.itemWidth.replace("px",""))-15,f="";return c.del&&(f='<span class="file_del" data-index="'+a.index+'" title="删除"></span>'),g="/Public/Static/html5Upload/images/fileType/",g+=a.name.indexOf(".rar")>0?"rar.png":a.name.indexOf(".zip")>0?"zip.png":a.name.indexOf(".text")>0?"txt.png":a.name.indexOf(".mp4")>0?"video.png":"other.png",0==a.type.indexOf("image")?(d+='<div  class="uploadList_'+a.index+'  upload_append_list">',d+=' <div class="file_bar">',d+='  <div style="padding:5px;">',d+='   <p class="file_name">'+a.name+"</p>",d+=f,d+="  </div>",d+=" </div>",d+=' <a style="height:'+c.itemHeight+";width:"+c.itemWidth+';" href="#" class="imgBox">',d+='  <div class="uploadImg" style="width:'+e+'px">',d+='   <img id="uploadImage_'+a.index+'" class="upload_image" src="'+b.target.result+'" style="width:expression(this.width > '+e+" ? "+e+'px : this.width)" />',d+="  </div>",d+=" </a>",d+=' <p class="uploadProgress_'+a.index+' file_progress"></p>',d+=' <p id="uploadFailure_'+a.index+'" class="file_failure">上传失败，请重试</p>',d+=' <p id="uploadSuccess_'+a.index+'" class="file_success"></p>',d+="</div>"):(d+='<div  class="uploadList_'+a.index+'  upload_append_list">',d+=' <div class="file_bar">',d+='  <div style="padding:5px;">',d+='   <p class="file_name">'+a.name+"</p>",d+=f,d+="  </div>",d+=" </div>",d+=' <a style="height:'+c.itemHeight+";width:"+c.itemWidth+';" href="#" class="imgBox">',d+='  <div class="uploadImg" style="width:'+e+'px">',d+='   <img id="uploadImage_'+a.index+'" class="upload_image" src="'+g+'" style="width:expression(this.width > '+e+" ? "+e+'px : this.width)" />',d+="  </div>",d+=" </a>",d+=' <p class="uploadProgress_'+a.index+' file_progress"></p>',d+=' <p id="uploadFailure_'+a.index+'" class="file_failure">上传失败，请重试</p>',d+=' <p id="uploadSuccess_'+a.index+'" class="file_success"></p>',d+="</div>"),d},this.createCorePlug=function(){var b={data:c.data,fileInput:a(c.parentsel+" .fileImage").get(0),uploadInput:a(c.parentsel+" .fileSubmit").get(0),dragDrop:a(c.parentsel+" .fileDragArea").get(0),url:a(c.parentsel+" .uploadForm").attr("action"),filterFile:function(a){return d.funFilterEligibleFile(a)},onSelect:function(b,e){var f,g,h,i,j,k;c.onSelect(b,e),d.funSetStatusInfo(d.ZYFILE.funReturnNeedFiles()),f="",g=0,h=function(){var c,a=b[g];a?(c=new FileReader,c.onload=function(b){f+=d.funDisposePreviewHtml(a,b),g++,h()},c.readAsDataURL(a)):i(f)},i=function(b){c.dragDrop?a(c.parentsel+" .preview").append(b):a(c.parentsel+" .add_upload").before(b),j(),k()},j=function(){a(c.parentsel+" .file_del").length>0&&a(c.parentsel+" .file_del").click(function(){return d.ZYFILE.funDeleteFile(parseInt(a(this).attr("data-index")),!0),!1}),a(c.parentsel+" .file_edit").length>0&&a(c.parentsel+" .file_edit").click(function(){return!1})},k=function(){a(c.parentsel+" .upload_append_list").hover(function(){a(this).find(".file_bar").addClass("file_hover")},function(){a(this).find(".file_bar").removeClass("file_hover")})},h()},onDelete:function(b,e){a(c.parentsel+"  .uploadList_"+b.index).fadeOut(),d.funSetStatusInfo(e)},onProgress:function(b,d,e){var f=a(c.parentsel+"  .uploadProgress_"+b.index),g=(100*(d/e)).toFixed(2)+"%";f.is(":hidden")&&f.show(),f.css("width",g),f.html(g)},onSuccess:function(b,e){c.onSuccess(b,e),c.finishDel&&(a(c.parentsel+"  .uploadList_"+b.index).fadeOut(),d.funSetStatusInfo(d.ZYFILE.funReturnNeedFiles()))},onFailure:function(a){c.onFailure(a)},onComplete:function(a){c.onComplete(a)},onDragOver:function(){a(this).addClass("upload_drag_hover")},onDragLeave:function(){a(this).removeClass("upload_drag_hover")}};d.ZYFILE=null,d.ZYFILE=a.extend(new UPLOADFILE,b),d.ZYFILE.init()},this.addEvent=function(){a(c.parentsel+" .filePicker").length>0&&a(c.parentsel+" .filePicker").bind("click",function(){a(c.parentsel+" .fileImage").click()}),a(c.parentsel+"   .webuploader_pick").bind("click",function(){a(c.parentsel+" .fileImage").click()}),a(c.parentsel+"   .upload_btn").bind("click",function(){d.ZYFILE.funReturnNeedFiles().length>0?a(c.parentsel+" .fileSubmit").click():alert("请先选中文件再点击上传")}),a(c.parentsel+"   .rapidAddImg").length>0&&a(c.parentsel+"   .rapidAddImg").bind("click",function(){a(c.parentsel+" .fileImage").click()})},this.init()})}}(jQuery);